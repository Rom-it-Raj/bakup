set autoindent
set tabstop=2
set shiftwidth=2
set smarttab
set softtabstop=2
set mouse=a
set foldcolumn=1
set foldmethod=indent
set foldlevel=99
set rnu
set nu
set termguicolors

lua vim.g.deprecation_warnings = false

" --- PLUGINS ---
call plug#begin()
Plug 'tpope/vim-surround'
Plug 'preservim/nerdtree'
Plug 'tpope/vim-commentary'
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'
Plug 'lifepillar/pgsql.vim'
Plug 'ap/vim-css-color'
Plug 'rafi/awesome-vim-colorschemes'

Plug 'williamboman/mason.nvim'
Plug 'williamboman/mason-lspconfig.nvim'
Plug 'neovim/nvim-lspconfig'
Plug 'hrsh7th/cmp-nvim-lsp'
Plug 'hrsh7th/cmp-buffer'
Plug 'hrsh7th/cmp-path'
Plug 'hrsh7th/cmp-cmdline'
Plug 'hrsh7th/nvim-cmp'
Plug 'L3MON4D3/LuaSnip', {'tag': 'v2.*', 'do': 'make install_jsregexp'}
Plug 'rafamadriz/friendly-snippets'
Plug 'hrsh7th/cmp-vsnip'
Plug 'hrsh7th/vim-vsnip'

Plug 'ryanoasis/vim-devicons'
Plug 'm4xshen/autoclose.nvim'
Plug 'nvim-lua/plenary.nvim'
Plug 'nvim-telescope/telescope.nvim', { 'tag': '0.1.8' }
Plug 'akinsho/toggleterm.nvim', {'tag' : '*'}
Plug 'rcarriga/nvim-notify'
Plug 'folke/noice.nvim'
Plug 'MunifTanjim/nui.nvim'

Plug 'loctvl842/monokai-pro.nvim'
Plug 'catppuccin/nvim', { 'as': 'catppuccin' }
Plug 'folke/tokyonight.nvim'
Plug 'rebelot/kanagawa.nvim'
Plug 'tiagovla/tokyodark.nvim'
Plug 'daltonmenezes/aura-theme', { 'rtp': 'packages/neovim' }
Plug 'zaldih/themery.nvim'

Plug 'nvim-treesitter/nvim-treesitter', {'do': ':TSUpdate'}
Plug 'lewis6991/gitsigns.nvim'
Plug 'lukas-reineke/indent-blankline.nvim'
Plug 'nvimtools/none-ls.nvim'
Plug 'RaafatTurki/hex.nvim'
Plug 'kevinhwang91/nvim-ufo'
Plug 'kevinhwang91/promise-async'
Plug 'numToStr/Comment.nvim'
Plug 'norcalli/nvim-colorizer.lua'

call plug#end()
" --- END PLUGINS ---

set encoding=UTF-8
set completeopt-=preview 
colorscheme purify

" --- Global Vars ---
let g:NERDTreeDirArrowExpandable="+"
let g:NERDTreeDirArrowCollapsible="~"
let g:airline#extensions#tabline#enabled = 1
"let g:airline_theme="jellybeans"
let g:airline_powerline_fonts = 1

" --- Mappings ---
nnoremap <C-n> :NERDTree<CR>
nnoremap <C-t> :NERDTreeToggle<CR>
nnoremap <C-q> :Themery<CR>
nnoremap <C-j> :bn <CR>
nnoremap <C-k> :bp <CR>
nnoremap <C-\> :ToggleTerm size=10 direction=horizontal <CR>
nnoremap <C-]> :ToggleTerm direction=float <CR>
nnoremap <C-f> <cmd>Telescope find_files<cr>
nnoremap <C-g> <cmd>Telescope live_grep<cr>
nnoremap <C-b> <cmd>Telescope buffers<cr>
nnoremap <C-h> <cmd>Telescope help_tags<cr>
nnoremap <C-x> :HexToggle <CR>
nnoremap <C-m> <cmd>lua vim.lsp.buf.format() <CR>

" --- LUA CONFIG ---
lua << EOF
    require("mason").setup()
    require("mason-lspconfig").setup()

    -- 1. CMP (Autocomplete) Setup
    local cmp = require'cmp'
    cmp.setup({
        snippet = {
            expand = function(args)
                vim.fn["vsnip#anonymous"](args.body) 
            end,
        },
        window = {
            completion = cmp.config.window.bordered(),
            documentation = cmp.config.window.bordered(),
        },
        mapping = cmp.mapping.preset.insert({
            ['<C-z>'] = cmp.mapping.scroll_docs(-4),
            ['<C-d>'] = cmp.mapping.scroll_docs(4),
            ['<C-Space>'] = cmp.mapping.complete(),
            ['<C-e>'] = cmp.mapping.abort(),
            ['<CR>'] = cmp.mapping.confirm({ select = true }),
        }),
        sources = cmp.config.sources({
            { name = 'nvim_lsp' },
            { name = 'vsnip' }, 
            { name = 'luasnip' }, 
        }, {
            { name = 'buffer' },
        })
    })

    cmp.setup.cmdline(':', {
        mapping = cmp.mapping.preset.cmdline(),
        sources = cmp.config.sources({
            { name = 'path' }
        }, {
            { name = 'cmdline' }
        }),
        matching = { disallow_symbol_nonprefix_matching = false }
    })

    -- 2. LSP Setup
    local capabilities = require('cmp_nvim_lsp').default_capabilities()
    local on_attach = function(client, bufnr)
        client.server_capabilities.documentFormattingProvider = false
        local map = vim.keymap.set
        local bufopts = {noremap = true, silent = true, buffer=bufnr}
        map('n', 'gD', vim.lsp.buf.declaration, bufopts)
        map('n', 'gd', vim.lsp.buf.definition, bufopts)
    end

    local lspconfig = require('lspconfig')

		vim.lsp.config('clangd', {
				 on_attach = on_attach,
        capabilities = capabilities,

			})
    
    local projectRoot = vim.loop.cwd()
    vim.lsp.config('pyright',{
        on_attach = on_attach,
       capabilities = capabilities,
       settings = {
           python = {
               venvPath = projectRoot,
               venv = ".env",
           }
       }
    })

    vim.lsp.config('html',{
        on_attach = on_attach,
        capabilities = capabilities,
        filetypes = { "html", "js" },
    })
    
    vim.lsp.config('eslint',{
         on_attach = on_attach,
         capabilities = capabilities,
    })

    require("luasnip.loaders.from_vscode").lazy_load()

    -- 3. Treesitter (Protected Call to fix your crash)
    local status, ts = pcall(require, "nvim-treesitter.configs")
    if status then
        ts.setup {
            ensure_installed = {'c', 'cpp', 'python', 'js', 'html'},
            highlight = { enable = true }
        }
    end

    require("autoclose").setup({
        keys = {
            ["("] = { escape = true, close = true, pair = "()", disabled_filetypes = {} },
            ["{"] = { escape = true, close = true, pair = "{}", disabled_filetypes = {} },
        },
    })
    
    require('telescope').setup{}
    require("toggleterm").setup()
    
    require("themery").setup({
        themes = {"purify", "kanagawa", "monokai-pro", "kanagawa-dragon", "tokyodark", "aura-dark"},
        livePreview = true,
    })

    -- Indent Blankline
    local highlight = {
        "RainbowRed", "RainbowYellow", "RainbowBlue", "RainbowOrange", "RainbowGreen", "RainbowViolet", "RainbowCyan",
    }
    local hooks = require "ibl.hooks"
    hooks.register(hooks.type.HIGHLIGHT_SETUP, function()
        vim.api.nvim_set_hl(0, "RainbowRed", { fg = "#E06C75" })
        vim.api.nvim_set_hl(0, "RainbowYellow", { fg = "#E5C07B" })
        vim.api.nvim_set_hl(0, "RainbowBlue", { fg = "#61AFEF" })
        vim.api.nvim_set_hl(0, "RainbowOrange", { fg = "#D19A66" })
        vim.api.nvim_set_hl(0, "RainbowGreen", { fg = "#98C379" })
        vim.api.nvim_set_hl(0, "RainbowViolet", { fg = "#C678DD" })
        vim.api.nvim_set_hl(0, "RainbowCyan", { fg = "#56B6C2" })
    end)
    require("ibl").setup { indent = { highlight = highlight } }

    -- Diagnostics
    vim.diagnostic.config({
			virtual_text = {
			spacing = 4,
			prefix = '‚óè', -- Or any character you like
			source = "if_many", -- Shows which tool (LSP/Linter) found the error
		},
			severity_sort = true,
			float = {
				border = 'rounded',
				source = 'always',
			},
		})
    require('colorizer').setup()
    require('ufo').setup({
        provider_selector = function(bufnr, filetype, buftype)
            return {'treesitter', 'indent'}
        end
    })

    -- Null-LS (Formatting)
    local null_ls = require('null-ls')
    null_ls.setup({
        sources = {
            null_ls.builtins.formatting.prettierd.with({
                filetypes = { "javascript", "javascriptreact", "typescript", "typescriptreact", "css" }
            }),
            null_ls.builtins.formatting.black.with({
                filetypes = { "python" }
            }),
            null_ls.builtins.formatting.clang_format.with({
                filetypes = { "cpp", "c" }
            }),
        }
    })

    require'hex'.setup()

    -- Noice & Notify
    require'notify'.setup({ background_colour = "#010101" })
    require'noice'.setup({
        cmdline = { enabled=true, view="cmdline_popup" },
        messages={ enabled=true, view='notify', view_error='notify', view_warn='notify' }
    })

    require("gitsigns").setup()
    require('Comment').setup()
		-- Suppress specific deprecation messages
EOF

autocmd BufWritePost *.v lua vim.lsp.buf.format({ async = false })
let g:airline_powerline_fonts = 0
let g:airline_left_sep = ''
let g:airline_right_sep = ''

let g:airline#extensions#whitespace#enabled = 0

set laststatus=2
if executable('clip.exe')
    let g:clipboard = {
          \   'name': 'WslClipboard',
          \   'copy': {
          \      '+': 'clip.exe',
          \      '*': 'clip.exe',
          \    },
          \   'paste': {
          \      '+': 'powershell.exe -c [Console]::Out.Write($(Get-Clipboard -Raw).tostring().replace("`r", ""))',
          \      '*': 'powershell.exe -c [Console]::Out.Write($(Get-Clipboard -Raw).tostring().replace("`r", ""))',
          \   },
          \   'cache_enabled': 0,
          \ }
endif

set clipboard+=unnamedplus
